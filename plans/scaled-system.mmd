graph TB
    %% DoxIn Production System - GCP Architecture with AI Chat Agent
    %% Fully scaled cloud-native deployment

    subgraph "User Layer"
        Users[End Users<br/>Invoice Processors]
        Admins[Admin Users]
    end

    subgraph "Edge Network"
        Vercel[Vercel Edge<br/>Global CDN<br/>Next.js SSR]
        CloudCDN[Cloud CDN<br/>Static Assets]
    end

    subgraph "GCP Load Balancing"
        GLB[Cloud Load Balancer<br/>Global HTTPS<br/>Cloud Armor WAF]
    end

    subgraph "GCP Region: us-central1"
        direction TB

        subgraph "Cloud Run Services"
            API[API Service<br/>2-20 instances<br/>2vCPU, 4GB RAM]
            Worker[Worker Service<br/>1-10 instances<br/>Background Jobs]
            QdrantSvc[Qdrant Service<br/>1-3 instances<br/>2vCPU, 8GB RAM<br/>Vector Search<br/>NEW]
        end

        subgraph "Managed Services"
            Memorystore[(Memorystore Redis<br/>2GB HA<br/>Cache & Queue)]
            CloudTasks[Cloud Tasks<br/>Job Queue<br/>Retry Logic]
            SecretMgr[Secret Manager<br/>API Keys<br/>Credentials]
        end

        subgraph "Storage"
            GCS[Cloud Storage<br/>Buckets<br/>Documents & Exports]
            QdrantVol[Persistent Disk<br/>50GB SSD<br/>Qdrant Data<br/>NEW]
        end

        subgraph "Networking"
            VPC[VPC Network<br/>Private IPs]
            CloudNAT[Cloud NAT<br/>Egress Gateway]
        end
    end

    subgraph "External: AWS us-east-1"
        Neon[(Neon PostgreSQL<br/>Serverless<br/>Auto-scaling<br/>Connection Pooling)]
    end

    subgraph "AI/ML Providers"
        GPT4[OpenAI GPT-4<br/>Vision + Chat<br/>Text-to-SQL]
        Claude[Anthropic Claude<br/>Complex Reasoning]
        HF[Hugging Face<br/>Llama/Mistral<br/>Cost-Effective]
        Embed[Embedding API<br/>text-embedding-3-small]
    end

    subgraph "Application Services"
        direction LR

        subgraph "Core Services"
            InvSvc[Invoice Service]
            ProcSvc[Processing Service]
            AuthSvc[Auth Service]
        end

        subgraph "AI Chat Agent NEW"
            ChatSvc[Chat Service<br/>Session Mgmt]
            IntentSvc[Intent Router<br/>Tool Selection]
            RAGSvc[RAG Service<br/>Doc Retrieval]
            SQLSvc[Text-to-SQL<br/>Query Generator]
            StreamSvc[Stream Manager<br/>SSE Events]
        end
    end

    subgraph "GCP Observability"
        CloudLog[Cloud Logging<br/>30d Retention]
        CloudMon[Cloud Monitoring<br/>Metrics & Alerts]
        CloudTrace[Cloud Trace<br/>Distributed Tracing]
    end

    %% User flow
    Users --> Vercel
    Admins --> Vercel
    Vercel --> GLB
    CloudCDN -.static.-> Vercel

    %% Load balancing
    GLB --> API

    %% API to services
    API --> InvSvc & ChatSvc & AuthSvc

    %% Chat agent flow
    ChatSvc --> IntentSvc
    IntentSvc -->|doc query| RAGSvc
    IntentSvc -->|data query| SQLSvc
    IntentSvc -->|action| InvSvc

    %% RAG service
    RAGSvc --> QdrantSvc
    RAGSvc --> Embed
    RAGSvc --> GPT4
    QdrantSvc --> QdrantVol

    %% Text-to-SQL
    SQLSvc --> GPT4
    SQLSvc --> Neon
    SQLSvc --> Memorystore

    %% Streaming
    ChatSvc --> StreamSvc
    StreamSvc -.SSE.-> Vercel

    %% Core invoice processing
    InvSvc --> ProcSvc
    ProcSvc --> CloudTasks
    CloudTasks --> Worker
    Worker --> Neon
    Worker --> GCS
    Worker --> GPT4

    %% LLM orchestration
    ChatSvc --> GPT4 & Claude & HF
    ProcSvc --> GPT4

    %% Data persistence
    API --> Memorystore
    API --> Neon
    Worker --> Memorystore
    ChatSvc --> Neon
    ChatSvc --> Memorystore

    %% VPC networking
    API --> VPC
    Worker --> VPC
    QdrantSvc --> VPC
    VPC --> Memorystore
    VPC --> CloudNAT
    CloudNAT --> Neon

    %% Secrets
    API --> SecretMgr
    Worker --> SecretMgr
    QdrantSvc --> SecretMgr

    %% Storage
    API --> GCS
    Worker --> GCS

    %% Monitoring
    API -.logs.-> CloudLog
    Worker -.logs.-> CloudLog
    QdrantSvc -.logs.-> CloudLog

    API -.metrics.-> CloudMon
    Worker -.metrics.-> CloudMon
    Memorystore -.metrics.-> CloudMon

    API -.traces.-> CloudTrace

    %% Styling
    classDef user fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef edge fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef lb fill:#fff3e0,stroke:#e65100,stroke-width:3px
    classDef compute fill:#e8f5e9,stroke:#1b5e20,stroke-width:3px
    classDef chatNew fill:#fff9c4,stroke:#f57f17,stroke-width:3px
    classDef managed fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef storage fill:#ffe0b2,stroke:#e65100,stroke-width:2px
    classDef vector fill:#f1f8e9,stroke:#33691e,stroke-width:3px
    classDef database fill:#e0f2f1,stroke:#004d40,stroke-width:2px
    classDef llm fill:#fff3e0,stroke:#ff6f00,stroke-width:2px
    classDef monitor fill:#e8eaf6,stroke:#1a237e,stroke-width:2px

    class Users,Admins user
    class Vercel,CloudCDN edge
    class GLB lb
    class API,Worker compute
    class QdrantSvc,QdrantVol vector
    class ChatSvc,IntentSvc,RAGSvc,SQLSvc,StreamSvc chatNew
    class InvSvc,ProcSvc,AuthSvc,VPC,CloudNAT managed
    class Memorystore,CloudTasks,SecretMgr managed
    class GCS storage
    class Neon database
    class GPT4,Claude,HF,Embed llm
    class CloudLog,CloudMon,CloudTrace monitor
